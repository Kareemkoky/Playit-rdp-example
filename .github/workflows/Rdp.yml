name: Free RDP with Proxy

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Download 3proxy
      run: |
        Invoke-WebRequest -Uri "https://github.com/3proxy/3proxy/releases/download/0.9.5/3proxy-0.9.5-x64.zip" -OutFile "$env:USERPROFILE\3proxy.zip"
        Expand-Archive -Path "$env:USERPROFILE\3proxy.zip" -DestinationPath "$env:USERPROFILE\3proxy"
    
    - name: Set Password for RDP
      run: |
        net user runneradmin "Pass1234!"
    
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Start 3proxy with Auth
      run: |
        $conf = @"
auth strong
users proxyuser:CL:proxypass
allow proxyuser
proxy -p3128
"@
        Set-Content -Path "$env:USERPROFILE\3proxy\3proxy.cfg" -Value $conf
        Start-Process -FilePath "$env:USERPROFILE\3proxy\3proxy.exe" -ArgumentList "$env:USERPROFILE\3proxy\3proxy.cfg"

    - name: Start Playit Tunnel
      run: |
        Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-windows-amd64.exe" -OutFile "$env:USERPROFILE\playit.exe"
        Start-Process -FilePath "$env:USERPROFILE\playit.exe"
        Start-Sleep -Seconds 15

    - name: Keep alive for 6 hours
      run: |
        for ($i = 0; $i -lt 360; $i++) {
          Write-Host "Minutes Passed: $i"
          Start-Sleep -Seconds 60
        }
